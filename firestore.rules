rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // Helper Functions
    // ==========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin (by email)
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'alexandra@skinselflove.pt';
    }
    
    // Check if user owns the pharmacy
    function isPharmacyOwner(pharmacyId) {
      return isAuthenticated() && 
             request.auth.token.pharmacyId == pharmacyId;
    }
    
    // Check if date is assigned to user's pharmacy
    function isDateAssignedToUser(dateStr) {
      return isAdmin() || 
             exists(/databases/$(database)/documents/dateAssignments/$(dateStr)) &&
             get(/databases/$(database)/documents/dateAssignments/$(dateStr)).data.pharmacyId == request.auth.token.pharmacyId;
    }

    // ==========================================
    // Pharmacies Collection
    // ==========================================
    
    match /pharmacies/{pharmacyId} {
      // Anyone authenticated can read pharmacy list (for login dropdown)
      allow read: if true;
      
      // Only admin can create/update/delete pharmacies
      allow write: if isAdmin();
    }

    // ==========================================
    // Config Collection (Admin settings)
    // ==========================================
    
    match /config/{configId} {
      // Admin password check happens client-side, but config read is protected
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ==========================================
    // Date Assignments Collection
    // ==========================================
    
    match /dateAssignments/{dateStr} {
      // Authenticated users can read to check their assignments
      allow read: if true;
      
      // Only admin can assign/unassign dates
      allow write: if isAdmin();
    }

    // ==========================================
    // Reservations Collection
    // ==========================================
    
    match /reservations/{reservationId} {
      // Users can read their own pharmacy's reservations
      // Admin can read all
      allow read: if isAdmin() || 
                    resource.data.pharmacyId == request.auth.token.pharmacyId;
      
      // Create: User must be assigned to the date
      allow create: if isDateAssignedToUser(request.resource.data.date) &&
                      (isAdmin() || request.resource.data.pharmacyId == request.auth.token.pharmacyId);
      
      // Update: Owner or admin can update
      allow update: if isAdmin() || 
                      resource.data.pharmacyId == request.auth.token.pharmacyId;
      
      // Delete: Only admin can hard-delete (use status: cancelled for soft delete)
      allow delete: if isAdmin();
    }

    // ==========================================
    // Legacy: Schedules Collection (v1 compatibility)
    // ==========================================
    
    match /schedules/{dateStr} {
      // Allow read/write for backward compatibility during migration
      // TODO: Remove after migration complete
      allow read, write: if true;
    }

    // ==========================================
    // Month Availability (Calendar dots)
    // ==========================================
    
    match /month_availability/{monthKey} {
      allow read: if true;
      allow write: if true; // Updated by client on booking
    }
  }
}
